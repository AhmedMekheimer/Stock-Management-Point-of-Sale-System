@model UsersWithSearchVM
@if (User.HasClaim("Permission", "User.View"))
{
	<div class="p-3">

		<div class="d-flex justify-content-between align-items-center mb-3">
			<h1 class="mb-0">Users</h1>

			<!-- Centered search bar -->
			<form asp-controller="User" asp-action="Index" method="get" class="row g-2 align-items-center" style="margin-top: 0px !important;">
				<!-- Search -->
				<div style="margin-top: 0px !important;">
					<div class="table-search-wrapper" style="width:400px;">
						<input asp-for="Search" class="form-control form-control-sm" placeholder="Search by Username or Email..." />
						<button type="submit" class="btn btn-sm btn-primary">
							<i class="fa fa-search"></i>
						</button>
					</div>
				</div>
			</form>

			<div class="d-flex align-items-center">
				@if (User.HasClaim("Permission", "User.Add"))
				{
					<a asp-action="Save" class="btn btn-primary">Add</a>
				}
			</div>
		</div>

		@if (Model.ApplicationUsers.Count == 0)
		{
			<h3>No Users Found</h3>
		}
		else
		{
			<div class="table-responsive">
				<table id="categoryTable" class="table table-striped  table-bordered">
					<thead class="thead-dark">
						<tr>
							<th width="30%">
								Username
							</th>
							<th width="40%">
								Email
							</th>
							<th width="15%">
								Actions
							</th>

						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model.ApplicationUsers)
						{
							<tr>
								<td>
									@item.UserName
								</td>
								<td>
									@item.Email
								</td>
								<td>
									<div class="d-flex gap-2 ">
										@if (User.HasClaim("Permission", "User.Edit"))
										{
											if (item.UserName == "SuperAdmin" && User.Identity!.Name == "SuperAdmin")
											{
												<a asp-action="Save" asp-route-id="@item.Id" class="btn btn-sm btn-info">
													Edit
												</a>
											}
											else if (item.UserName != "SuperAdmin")
											{
												<a asp-action="Save" asp-route-id="@item.Id" class="btn btn-sm btn-info">
													Edit
												</a>
											}
										}
										@if (User.Identity!.Name != item.UserName && User.HasClaim("Permission", "User.Delete") && item.UserName != "SuperAdmin")
										{
											<button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal"
													data-id="@item.Id" data-name="@item.UserName">
												Delete
											</button>
										}
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		}
	</div>
	@if (Model.NoPages != 0)
	{
		<div class="d-flex justify-content-center">
			<nav aria-label="Page navigation example">
				<ul class="pagination custom-pagination mb-0">
					@if (Model.PageId > 1)
					{
						<li class="page-item">
							<a class="page-link" asp-controller="User" asp-action="Index"
							   asp-route-PageId="@(Model.PageId - 1)" asp-route-Search="@Model.Search">
								Previous
							</a>
						</li>
					}
					@for (int i = 1; i <= Model.NoPages; i++)
					{
						<li class="page-item @(i == Model.PageId ? "active" : "")">
							<a class="page-link"
							   asp-controller="User" asp-action="Index" asp-route-PageId="@i" asp-route-Search="@Model.Search">
								@i
							</a>
						</li>
					}
					@if (Model.NoPages > Model.PageId)
					{
						<li class="page-item">
							<a class="page-link" asp-controller="User" asp-action="Index"
							   asp-route-PageId="@(Model.PageId + 1)" asp-route-Search="@Model.Search">
								Next
							</a>
						</li>
					}
				</ul>
			</nav>
		</div>
	}

	<partial name="Delete" />

	@section Scripts {
		<script>
			$('#confirmDeleteModal').on('show.bs.modal', function (event) {
				var button = $(event.relatedTarget);

				var Id = button.data('id');
				var Name = button.data('name');

				$(this).find('#Name').text(Name);
				$(this).find('#IdToDelete').val(Id);
			});

			$('#confirmDeleteButton').on('click', function () {
				$('#deleteUser').submit();
			});
		</script>
	}

	@section Styles {
		<link href="~/css/tableStyling.css" rel="stylesheet" />
		<link href="~/css/pagination.css" rel="stylesheet" />
	}
}